<!-- Modal -->
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-gray-800 rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
    <!-- Modal header -->
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 class="text-xl font-semibold text-white">
          Add New Product
        </h3>
        <p class="text-sm text-gray-200 mt-1">Share your flex kick product</p>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    <!-- Modal body -->
    <div class="px-6 py-4 space-y-6 form-style">
      <form id="productForm">

        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-white mb-2">Name</label>
          <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter product name" required>
        </div>

        <div class="mb-4">
          <label for="price" class="block text-sm font-medium text-white mb-2">Price</label>
          <input type="number" id="price" name="price" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter product price" required>
        </div>

        <div class="mb-4">
          <label for="brand" class="block text-sm font-medium text-white mb-2">Brand</label>
          <input type="text" id="brand" name="brand" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter brand name" required>
        </div>

        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-white mb-2">Description</label>
          <textarea id="description" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter product description" required></textarea>
        </div>

        <div class="mb-4">
          <label for="category" class="block text-sm font-medium text-white mb-2">Category</label>
          <select id="category" name="category" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
            <option value="">Choose a category</option>
            <option value="clothing">Clothing</option>
            <option value="footwear">Footwear</option>
            <option value="bag">Bag</option>
            <option value="equipment">Equipment</option>
            <option value="merchandise">Merchandise</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="thumbnail" class="block text-sm font-medium text-white">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="https://example.com/image.jpg">
        </div>

        <div class="mb-4">
          <div class="flex items-center">
            <input id="is_featured" name="is_featured" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded">
            <label for="is_featured" class="ml-2 text-sm font-medium text-white">Featured Product</label>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal footer -->
    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
      <button type="button" id="cancelButton" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-300 rounded-md font-medium hover:bg-gray-50 hover:text-gray-300 transition-colors text-center" onclick="hideModal()">Cancel</button>
      <button type="submit" id="submitProduct" form="productForm" class="order-1 sm:order-2 flex-1 bg-blue-600 text-white px-6 py-3 rounded-md font-medium hover:bg-blue-700 transition-colors">Add Product</button>
    </div>
  </div>
</div>

<script>
  // ---------- state ----------
  let isEditMode = false;
  let currentEditProductId = null;

  // ---------- CSRF helper ----------
  function getCookieLocal(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken_local = getCookieLocal('csrftoken');

  // ---------- modal show / hide ----------
  function showModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');
    if (!modal || !modalContent) return;
    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
  }

  function hideModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');
    if (!modal || !modalContent) return;

    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    setTimeout(() => {
      modal.classList.add('hidden');
      // reset state & form
      isEditMode = false;
      currentEditProductId = null;
      const form = document.getElementById('productForm');
      if (form) form.reset();
      const titleEl = document.querySelector('#crudModalContent h3');
      const submitBtn = document.getElementById('submitProduct');
      if (titleEl) titleEl.textContent = 'Add New Product';
      if (submitBtn) submitBtn.textContent = 'Add Product';
    }, 150);
  }

  // ---------- populate form ----------
  function populateFormWithProduct(product) {
    if (!product) return;
    const setIf = (id, value) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.value = (value === undefined || value === null) ? '' : String(value);
    };

    setIf('name', product.name);
    setIf('price', product.price);
    setIf('brand', product.brand);
    setIf('description', product.description);
    setIf('thumbnail', product.thumbnail);

    // select
    const sel = document.getElementById('category');
    if (sel) {
      const found = Array.from(sel.options).some(o => o.value === product.category);
      sel.value = found ? product.category : '';
    }

    // checkbox
    const cb = document.getElementById('is_featured');
    if (cb) {
      cb.checked = (product.is_featured === true || product.is_featured === 'true' || product.is_featured === 1 || product.is_featured === '1');
    }

    const titleEl = document.querySelector('#crudModalContent h3');
    const submitBtn = document.getElementById('submitProduct');
    if (titleEl) titleEl.textContent = 'Edit Product';
    if (submitBtn) submitBtn.textContent = 'Update Product';
  }

  // ---------- open add / edit ----------
  function openAddModal() {
    isEditMode = false;
    currentEditProductId = null;
    const form = document.getElementById('productForm');
    if (form) form.reset();
    const titleEl = document.querySelector('#crudModalContent h3');
    const submitBtn = document.getElementById('submitProduct');
    if (titleEl) titleEl.textContent = 'Add New Product';
    if (submitBtn) submitBtn.textContent = 'Add Product';
    showModal();
  }

  async function openEditModal(productId) {
    if (!productId) return;
    isEditMode = true;
    currentEditProductId = productId;

    // first try client cache
    let product = null;
    try {
      if (window.allProductData && Array.isArray(window.allProductData)) {
        product = window.allProductData.find(p => String(p.id) === String(productId));
      }
    } catch (err) {
      console.warn('openEditModal: error accessing client cache', err);
    }

    // fallback fetch from server if not found
    if (!product) {
      try {
        const urlTemplate = "{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}";
        const url = urlTemplate.replace('00000000-0000-0000-0000-000000000000', productId);
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (resp.ok) product = await resp.json();
        else console.warn('openEditModal: fetch failed', resp.status);
      } catch (err) {
        console.error('openEditModal fetch error', err);
      }
    }

    if (product) populateFormWithProduct(product);
    else {
      // leave form empty but set UI to edit mode
      const titleEl = document.querySelector('#crudModalContent h3');
      const submitBtn = document.getElementById('submitProduct');
      if (titleEl) titleEl.textContent = 'Edit Product';
      if (submitBtn) submitBtn.textContent = 'Update Product';
    }

    showModal();
  }

  // expose to global so main.html can call
  window.openAddModal = openAddModal;
  window.openEditModal = openEditModal;

  // ---------- AJAX add / edit ----------
  async function addProductEntry() {
    const form = document.getElementById('productForm');
    if (!form) return false;
    try {
      const resp = await fetch("{% url 'main:add_product_entry_ajax' %}", {
        method: "POST",
        headers: { 'X-CSRFToken': csrftoken_local },
        body: new FormData(form)
      });
      if (!resp.ok) {
        console.error('add failed', resp.status);
        showToast('Failed to add product', '', 'error');
        return false;
      }
      form.reset();
      hideModal();
      showToast('Product added successfully!', '', 'success');
      if (typeof window.fetchProductFromServer === 'function') window.fetchProductFromServer();
      else document.dispatchEvent(new CustomEvent('productAdded'));
      return true;
    } catch (err) {
      console.error('addProductEntry error', err);
      showToast('Error adding product', '', 'error');
      return false;
    }
  }

  async function editProductEntry(productId) {
    if (!productId) {
      showToast('Product id missing', '', 'error');
      return false;
    }
    const form = document.getElementById('productForm');
    if (!form) return false;
    const editUrlTemplate = "{% url 'main:edit_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}";
    const editUrl = editUrlTemplate.replace('00000000-0000-0000-0000-000000000000', productId);

    try {
      const resp = await fetch(editUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken_local },
        body: new FormData(form)
      });
      if (!resp.ok) {
        console.error('edit failed', resp.status);
        showToast('Failed to update product', '', 'error');
        return false;
      }
      form.reset();
      hideModal();
      showToast('Product updated successfully!', '', 'success');
      if (typeof window.fetchProductFromServer === 'function') window.fetchProductFromServer();
      else document.dispatchEvent(new CustomEvent('productEdited', { detail: { id: productId } }));
      return true;
    } catch (err) {
      console.error('editProductEntry error', err);
      showToast('Error while updating product', '', 'error');
      return false;
    }
  }

  // ---------- form submit routing ----------
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('productForm');
    if (!form) return;
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (isEditMode && currentEditProductId) editProductEntry(currentEditProductId);
      else addProductEntry();
    });
  });
</script>
